{% extends "dashboard/base_dashboard.html" %}
{% block page_title %}Timezone Conversion{% endblock %}

{% block dashboard_content %}
<div class="space-y-6">
  <!-- Header -->
  <div>
    <h2 class="text-2xl font-bold text-white">Timezone Conversion</h2>
    <p class="text-gray-400 mt-1">View and convert event times to different timezones</p>
  </div>

  <!-- Timezone Selector -->
  <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 space-y-4">
    <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0">
      <div class="flex-1">
        <label class="block text-gray-300 text-sm mb-2">Select Timezone</label>
        <select id="timezoneSelect" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" data-default="{{ default_timezone }}">
          {% for tz_value, tz_label in timezone_choices %}
          <option value="{{ tz_value }}" {% if tz_value == default_timezone %}selected{% endif %}>{{ tz_label }}</option>
          {% endfor %}
        </select>
      </div>
      <button id="resetTimezoneBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
        Reset to Profile Timezone
      </button>
    </div>
  </div>

  <!-- Current Timezone Info -->
  <div class="bg-blue-600 rounded-lg p-4 text-white space-y-1">
    <p class="text-sm">Selected timezone: <strong id="selectedTzSummaryLabel">{{ default_timezone_label }}</strong> <span class="text-blue-100" id="selectedTzSummaryOffset">({{ default_timezone_offset }})</span></p>
    <p class="text-sm">Your timezone: <strong>{{ profile_timezone_label }}</strong> <span class="text-blue-100">({{ profile_timezone_offset }})</span></p>
  </div>

  <!-- Events List -->
  <div class="bg-gray-800 rounded-lg border border-gray-700">
    <div class="p-6 border-b border-gray-700 flex items-center justify-between">
      <h3 class="text-lg font-semibold text-white">Event Conversions</h3>
      <p class="text-gray-400 text-sm" id="eventsCountLabel"></p>
    </div>
    <div class="p-6 space-y-4" id="eventsContainer">
      <p id="noEventsMessage" class="text-gray-400 text-center py-12 {% if has_events %}hidden{% endif %}">
        No events to convert yet. <a href="{% url 'dashboard:calendar' %}" class="text-blue-400 hover:underline">Create an event</a>
      </p>
    </div>
  </div>

  <!-- Comparison Table -->
  <div class="bg-gray-800 rounded-lg border border-gray-700 hidden" id="comparisonSection">
    <div class="p-6 border-b border-gray-700 flex items-center justify-between">
      <h3 class="text-lg font-semibold text-white">Timezone Comparison Matrix</h3>
      <p class="text-gray-400 text-sm">Your timezone vs selected timezone vs UTC</p>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-700">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Event</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Your Timezone ({{ profile_timezone_label }})</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Selected Timezone</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">UTC</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-700" id="comparisonTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const timezoneConversionConfig = {
    events: JSON.parse('{{ events_json|escapejs }}'),
    timezoneLabels: JSON.parse('{{ timezone_meta_json|escapejs }}'),
    defaultTimezone: '{{ default_timezone }}',
    defaultTimezoneLabel: '{{ default_timezone_label }}',
    defaultTimezoneOffset: '{{ default_timezone_offset }}',
    profileTimezone: '{{ profile_timezone }}',
    profileTimezoneLabel: '{{ profile_timezone_label }}',
    profileTimezoneOffset: '{{ profile_timezone_offset }}'
  };

  (function() {
    const locale = navigator.language || 'en-US';
    const {
      events,
      timezoneLabels,
      defaultTimezone,
      defaultTimezoneLabel,
      defaultTimezoneOffset,
      profileTimezone,
      profileTimezoneLabel,
      profileTimezoneOffset
    } = timezoneConversionConfig;

    const timezoneSelect = document.getElementById('timezoneSelect');
    const resetBtn = document.getElementById('resetTimezoneBtn');
    const selectedLabelEl = document.getElementById('selectedTzSummaryLabel');
    const selectedOffsetEl = document.getElementById('selectedTzSummaryOffset');
    const eventsContainer = document.getElementById('eventsContainer');
    const noEventsMessage = document.getElementById('noEventsMessage');
    const comparisonSection = document.getElementById('comparisonSection');
    const comparisonTableBody = document.getElementById('comparisonTableBody');
    const eventsCountLabel = document.getElementById('eventsCountLabel');

    const tzAbbrevCache = new Map();

    function getTimeZoneAbbrev(date, tz) {
      const cacheKey = tz + date.getTimezoneOffset();
      if (tzAbbrevCache.has(cacheKey)) {
        return tzAbbrevCache.get(cacheKey);
      }
      try {
        const parts = new Intl.DateTimeFormat(locale, { timeZone: tz, timeZoneName: 'short' }).formatToParts(date);
        const part = parts.find((p) => p.type === 'timeZoneName');
        const value = part ? part.value : 'GMT';
        tzAbbrevCache.set(cacheKey, value);
        return value;
      } catch (err) {
        return 'GMT';
      }
    }

    function formatDateTime(isoString, tz) {
      const date = new Date(isoString);
      const dateStr = new Intl.DateTimeFormat(locale, {
        timeZone: tz,
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      }).format(date);
      const timeStr = new Intl.DateTimeFormat(locale, {
        timeZone: tz,
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      }).format(date);
      const tzAbbrev = getTimeZoneAbbrev(date, tz);
      return { dateStr, timeStr, tzAbbrev };
    }

    function updateSummary(selectedTz) {
      const label = timezoneLabels[selectedTz] || selectedTz;
      selectedLabelEl.textContent = label;
      const offset = getTimeZoneAbbrev(new Date(), selectedTz);
      selectedOffsetEl.textContent = `(${offset})`;
    }

    function renderEvents(selectedTz) {
      eventsContainer.innerHTML = '';
      comparisonTableBody.innerHTML = '';

      if (!events.length) {
        noEventsMessage.classList.remove('hidden');
        comparisonSection.classList.add('hidden');
        eventsCountLabel.textContent = '';
        return;
      }

      noEventsMessage.classList.add('hidden');
      comparisonSection.classList.remove('hidden');
      eventsCountLabel.textContent = `${events.length} event${events.length === 1 ? '' : 's'} shown`;

      events.forEach((event) => {
        const startSelected = formatDateTime(event.start, selectedTz);
        const endSelected = formatDateTime(event.end, selectedTz);
        const startProfile = formatDateTime(event.start, profileTimezone);
        const endProfile = formatDateTime(event.end, profileTimezone);
        const startUtc = formatDateTime(event.start, 'UTC');
        const endUtc = formatDateTime(event.end, 'UTC');

        const card = document.createElement('div');
        card.className = 'bg-gray-700 rounded-lg p-4 space-y-4';
        card.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <h4 class="text-white font-semibold text-lg">${event.title || 'Untitled Event'}</h4>
              ${event.description ? `<p class="text-gray-400 text-sm mt-1">${event.description}</p>` : ''}
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div>
              <p class="text-gray-500 text-xs uppercase mb-1">Start (${timezoneLabels[selectedTz] || selectedTz})</p>
              <p class="text-white font-semibold">${startSelected.dateStr}</p>
              <p class="text-blue-400 font-bold text-lg">${startSelected.timeStr} <span class="text-gray-400 text-sm">(${startSelected.tzAbbrev})</span></p>
              <p class="text-gray-500 text-xs mt-2">Your timezone: <span class="text-gray-300 font-medium">${startProfile.dateStr} ‚Ä¢ ${startProfile.timeStr}</span> <span class="text-gray-400">(${startProfile.tzAbbrev})</span></p>
              <p class="text-gray-500 text-xs mt-1">UTC: <span class="text-gray-300 font-medium">${startUtc.dateStr} ‚Ä¢ ${startUtc.timeStr}</span> <span class="text-gray-400">(${startUtc.tzAbbrev})</span></p>
            </div>
            <div>
              <p class="text-gray-500 text-xs uppercase mb-1">End (${timezoneLabels[selectedTz] || selectedTz})</p>
              <p class="text-white font-semibold">${endSelected.dateStr}</p>
              <p class="text-blue-400 font-bold text-lg">${endSelected.timeStr} <span class="text-gray-400 text-sm">(${endSelected.tzAbbrev})</span></p>
              <p class="text-gray-500 text-xs mt-2">Your timezone: <span class="text-gray-300 font-medium">${endProfile.dateStr} ‚Ä¢ ${endProfile.timeStr}</span> <span class="text-gray-400">(${endProfile.tzAbbrev})</span></p>
              <p class="text-gray-500 text-xs mt-1">UTC: <span class="text-gray-300 font-medium">${endUtc.dateStr} ‚Ä¢ ${endUtc.timeStr}</span> <span class="text-gray-400">(${endUtc.tzAbbrev})</span></p>
            </div>
          </div>
          ${event.location ? `<div class="pt-4 border-t border-gray-600 text-sm text-gray-400">üìç ${event.location}</div>` : ''}
        `;

        eventsContainer.appendChild(card);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-white font-medium">${event.title || 'Untitled Event'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-gray-300">${startProfile.dateStr} ‚Ä¢ ${startProfile.timeStr} <span class="text-gray-500 text-xs">(${startProfile.tzAbbrev})</span></td>
          <td class="px-6 py-4 whitespace-nowrap text-blue-400 font-semibold">${startSelected.dateStr} ‚Ä¢ ${startSelected.timeStr} <span class="text-gray-500 text-xs">(${startSelected.tzAbbrev})</span></td>
          <td class="px-6 py-4 whitespace-nowrap text-gray-400 text-sm">${startUtc.dateStr} ‚Ä¢ ${startUtc.timeStr} <span class="text-gray-500 text-xs">(${startUtc.tzAbbrev})</span></td>
        `;
        comparisonTableBody.appendChild(row);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      timezoneSelect.value = timezoneSelect.dataset.default || defaultTimezone;
      updateSummary(timezoneSelect.value || defaultTimezone);
      renderEvents(timezoneSelect.value || defaultTimezone);

      timezoneSelect.addEventListener('change', (e) => {
        const selectedTz = e.target.value;
        updateSummary(selectedTz);
        renderEvents(selectedTz);
        const params = new URLSearchParams(window.location.search);
        params.set('timezone', selectedTz);
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState({}, '', newUrl);
      });

      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          timezoneSelect.value = profileTimezone;
          updateSummary(profileTimezone);
          renderEvents(profileTimezone);
          const params = new URLSearchParams(window.location.search);
          params.set('timezone', profileTimezone);
          const newUrl = `${window.location.pathname}?${params.toString()}`;
          window.history.replaceState({}, '', newUrl);
        });
      }
    });
  })();
</script>
{% endblock %}

