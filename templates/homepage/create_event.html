{% extends "homepage/base_dashboard.html" %}
{% block page_title %}Create Event{% endblock %}

{% block dashboard_content %}
<div class="max-w-2xl">
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-white">Create New Event</h2>
    <p class="text-gray-400 mt-1">Add a new event to your calendar</p>
  </div>

  <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
    <form method="post" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="client_tz" id="client_tz">
      
      <div>
        <label class="block text-gray-300 text-sm mb-2">Title *</label>
        {{ form.title }}
        {% if form.title.errors %}
        <p class="text-red-400 text-xs mt-1">{{ form.title.errors }}</p>
        {% endif %}
      </div>

      <div>
        <label class="block text-gray-300 text-sm mb-2">Description</label>
        {{ form.description }}
        {% if form.description.errors %}
        <p class="text-red-400 text-xs mt-1">{{ form.description.errors }}</p>
        {% endif %}
      </div>

      <div>
        <label class="block text-gray-300 text-sm mb-2">Invite Participants</label>
        <div class="relative">
          <div id="participants-container" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus-within:ring-2 focus-within:ring-blue-500 min-h-[42px] flex flex-wrap gap-2 items-center">
            <input type="text" id="participant-input" 
              class="flex-1 bg-transparent border-none text-white placeholder-gray-400 focus:outline-none min-w-[200px]" 
              placeholder="Type username or email to search..." 
              autocomplete="off" />
          </div>
          <input type="hidden" name="invite_participants" id="invite_participants" value="" />
          <div id="user-suggestions" class="absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto"></div>
        </div>
        {% if form.invite_participants.errors %}
        <p class="text-red-400 text-xs mt-1">{{ form.invite_participants.errors }}</p>
        {% endif %}
        <p class="text-gray-500 text-xs mt-1">Type to search and select registered users</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-300 text-sm mb-2">Start Time *</label>
          {{ form.start_time }}
          {% if form.start_time.errors %}
          <p class="text-red-400 text-xs mt-1">{{ form.start_time.errors }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-gray-300 text-sm mb-2">End Time *</label>
          {{ form.end_time }}
          {% if form.end_time.errors %}
          <p class="text-red-400 text-xs mt-1">{{ form.end_time.errors }}</p>
          {% endif %}
        </div>
      </div>

      <div>
        <label class="block text-gray-300 text-sm mb-2">Location</label>
        {{ form.location }}
        {% if form.location.errors %}
        <p class="text-red-400 text-xs mt-1">{{ form.location.errors }}</p>
        {% endif %}
      </div>

      <div>
        <label class="block text-gray-300 text-sm mb-2">Invitation Link</label>
        <div class="flex items-center space-x-2">
          <input type="text" id="invitation_link" readonly 
            class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 text-gray-400 focus:outline-none" 
            value="Click 'Generate Link' to create an invitation link" />
          <button type="button" id="generate_link_btn" onclick="generateInvitationLink()"
            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors whitespace-nowrap">
            Generate Link
          </button>
          <button type="button" id="copy_link_btn" onclick="copyInvitationLinkCreate()" disabled
            class="px-4 py-2 bg-gray-600 text-gray-400 rounded-lg cursor-not-allowed whitespace-nowrap">
            Copy
          </button>
        </div>
        <input type="hidden" name="invitation_link" id="invitation_link_hidden" value="" />
        <p class="text-gray-500 text-xs mt-1">Generate and share this link with participants to let them view event details</p>
      </div>

      <div class="flex items-center space-x-4 pt-4">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
          Create Event
        </button>
        <a href="{% url 'homepage:calendar' %}" class="text-gray-400 hover:text-white">Cancel</a>
      </div>
    </form>
  </div>
</div>
<script>
  (function(){
    var tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    var el = document.getElementById('client_tz');
    if (el) { el.value = tz; }
  })();

  // Participant autocomplete functionality
  const participantInput = document.getElementById('participant-input');
  const participantsContainer = document.getElementById('participants-container');
  const inviteParticipantsField = document.getElementById('invite_participants');
  const suggestionsBox = document.getElementById('user-suggestions');
  let selectedParticipants = [];
  let searchTimeout;

  // Search users as user types
  participantInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(searchTimeout);
    
    if (query.length < 2) {
      suggestionsBox.classList.add('hidden');
      return;
    }

    searchTimeout = setTimeout(() => {
      fetch(`/homepage/api/search-users/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          displaySuggestions(data.users);
        })
        .catch(error => console.error('Error searching users:', error));
    }, 300);
  });

  function displaySuggestions(users) {
    if (users.length === 0) {
      suggestionsBox.classList.add('hidden');
      return;
    }

    suggestionsBox.innerHTML = users.map(user => `
      <div class="px-4 py-2 hover:bg-gray-600 cursor-pointer transition-colors border-b border-gray-600 last:border-b-0"
           onclick="addParticipant('${user.email}', '${user.username}', '${user.full_name}')">
        <div class="font-semibold text-white">${user.username}</div>
        <div class="text-sm text-gray-400">${user.email}</div>
        ${user.full_name ? `<div class="text-xs text-gray-500">${user.full_name}</div>` : ''}
      </div>
    `).join('');
    
    suggestionsBox.classList.remove('hidden');
  }

  function addParticipant(email, username, fullName) {
    // Check if already added
    if (selectedParticipants.includes(email)) {
      suggestionsBox.classList.add('hidden');
      participantInput.value = '';
      return;
    }

    selectedParticipants.push(email);
    
    // Create chip with profile image placeholder and name
    const chip = document.createElement('span');
    chip.className = 'inline-flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded-full text-sm';
    chip.setAttribute('data-email', email);
    
    const displayName = fullName || username;
    
    chip.innerHTML = `
      <div class="flex items-center gap-2">
        <div class="w-6 h-6 bg-gray-700 rounded-full flex items-center justify-center text-xs font-bold">
          ${username.charAt(0).toUpperCase()}
        </div>
        <span>${displayName}</span>
      </div>
      <button type="button" onclick="removeParticipant('${email}', this)" class="hover:text-red-300 focus:outline-none ml-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    `;
    
    participantsContainer.insertBefore(chip, participantInput);
    updateHiddenField();
    
    participantInput.value = '';
    suggestionsBox.classList.add('hidden');
  }

  function removeParticipant(email, button) {
    selectedParticipants = selectedParticipants.filter(p => p !== email);
    button.parentElement.remove();
    updateHiddenField();
  }

  function updateHiddenField() {
    inviteParticipantsField.value = selectedParticipants.join(', ');
  }

  // Close suggestions when clicking outside
  document.addEventListener('click', function(e) {
    if (!participantsContainer.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.classList.add('hidden');
    }
  });

  // Handle keyboard navigation
  participantInput.addEventListener('keydown', function(e) {
    if (e.key === 'Backspace' && participantInput.value === '' && selectedParticipants.length > 0) {
      const lastEmail = selectedParticipants[selectedParticipants.length - 1];
      const chips = participantsContainer.querySelectorAll('span');
      const lastChip = chips[chips.length - 1];
      if (lastChip) {
        removeParticipant(lastEmail, lastChip.querySelector('button'));
      }
    }
  });

  // Generate invitation link
  function generateInvitationLink() {
    const generateBtn = document.getElementById('generate_link_btn');
    const linkInput = document.getElementById('invitation_link');
    const linkHidden = document.getElementById('invitation_link_hidden');
    const copyBtn = document.getElementById('copy_link_btn');
    
    // Generate a unique meeting token
    const meetingToken = generateUniqueId();
    const baseUrl = window.location.origin;
    const invitationLink = `${baseUrl}/homepage/meeting/${meetingToken}`;
    
    linkInput.value = invitationLink;
    linkInput.classList.remove('text-gray-400');
    linkInput.classList.add('text-white');
    linkHidden.value = invitationLink;
    
    // Enable copy button
    copyBtn.disabled = false;
    copyBtn.classList.remove('bg-gray-600', 'text-gray-400', 'cursor-not-allowed');
    copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white');
    
    // Change button text
    generateBtn.textContent = 'Regenerate';
  }

  function generateUniqueId() {
    return 'xxxxxxxxxxxxxxxx'.replace(/x/g, function() {
      return Math.floor(Math.random() * 16).toString(16);
    });
  }

  function copyInvitationLinkCreate() {
    const linkInput = document.getElementById('invitation_link');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(linkInput.value).then(() => {
      const btn = document.getElementById('copy_link_btn');
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      btn.classList.add('bg-green-600', 'hover:bg-green-700');
      btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
      }, 2000);
    });
  }
</script>
{% endblock %}



